<div class="flex_row h_100 justify_strech">
  <!-- LEFT SIDEBAR -->
  <div class="flex_col space_between margin_r width_sibedar_width">
    <div
      class="border margin_b padding pseudo_input hover_highlight_border flex_row mono"
      [ngClass]="{
                highlight_border: controlBar.value,
            }"
    >
      @if (highlightedSystemAction()) {
      <span
        class="margin_r preserve_whitespace {{
          highlightedSystemAction()?.color ?? ''
        }}"
        >{{ highlightedSystemAction()?.command + " " }}</span
      >
      }
      <input
        #controlBar
        [placeholder]="
          highlightedSystemAction()?.advice ?? 'Type here to control shortrest'
        "
        (keydown)="systemBarOnKeyDown($event)"
        (keyup)="systemBarOnKeyUp($event)"
        (blur)="onBlurSystemBar()"
      />
      <span
        class="icon rounded iconoir-xmark color_fg4 hover_cursor_pointer hover_color_fg"
        (click)="controlBar.value = ''"
      ></span>
    </div>
    <div class="flex_col width_sibedar_width space_between grow">
      <app-file-list
        #fileList
        [files]="activeArchiveFiles | filterFiles : controlBar.value"
        [activeFile]="this.activeFileName"
        [systemBar]="controlBar.value"
        (fileActivated)="
          controlBar.value === $event
            ? openFile($event)
            : (controlBar.value = $event)
        "
        (wheel)="
          scrollIndexIncrementDecrement(true, $event, activeArchiveFiles)
        "
      >
      </app-file-list>
      <div class="border_color_bg flex_row space_between">
        <span class="border padding">Unnamed Library</span>
        <div>
          <span
            class="icon color_fg4 rounded iconoir-floppy-disk-arrow-in border padding"
          ></span>
          <span
            class="icon color_fg4 rounded iconoir-floppy-disk-arrow-out border padding"
          ></span>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER AREA -->
  <div class="flex_col grow">
    <div class="flex_row space_between">
      <div class="flex_row margin_b">
        @for ( system_action of system_actions; track system_action.command ) {
        <div
          class="border box_sizing_border_box w_34px_highlighted_w_150px flex_row padding hover_cursor_pointer color_fg4 overflow_hidden margin_r {{
            system_action.color
          }}"
          [ngClass]="{
                          highlighted: system_action.highlighted(),
                          highlight_border: system_action.highlighted(),
                          color_fg: system_action.highlighted(),
                        }"
          (click)="systemActionOnClick(system_action, controlBar)"
          (mouseenter)="system_action.highlighted.set(true)"
          (mouseleave)="system_action.highlighted.set(false)"
        >
          <span
            class="bg_h text_overflow_fade overflow_hidden grow max_w_0_highlighted_max_w_200px opacity_0_highlighted_opacity_1"
            [ngClass]="{
              highlighted: system_action.highlighted(),
            }"
          >
            {{ system_action.name }}
          </span>
          <span
            class="icon {{ system_action.icon }} {{
              system_action.highlighted() ? system_action.color : ''
            }}"
          ></span>
        </div>
        }
      </div>
      <div class="flex_row margin_b">
        <div
          class="flex border padding margin_r rounded_tl hover_highlight_border bg_s hover_cursor_pointer user_select_none"
        >
          Apple
        </div>
        <div
          class="flex border padding margin_r rounded_tr hover_highlight_border bg color_fg4 hover_cursor_pointer user_select_none"
        >
          Braeburn
        </div>
        <div class="flex">
          <span
            class="flex icon color_fg4 rounded iconoir-code border padding margin_r hover_highlight_border"
            (click)="editMode = !editMode || !readMode"
          ></span>
          <span
            class="flex icon rounded iconoir-edit-pencil border padding margin_r"
            [ngClass]="{
              color_fg4: !editMode,
              hover_cursor_pointer: !(editMode && !readMode),
              hover_highlight_border: !(editMode && !readMode),
              border_bottom_color_fg4: editMode
            }"
            (click)="editMode = !editMode || !readMode"
          ></span>
          <span
            class="flex icon rounded iconoir-open-book border padding"
            [ngClass]="{
              color_fg4: !readMode,
              hover_cursor_pointer: !(readMode && !editMode),
              hover_highlight_border: !(readMode && !editMode),
              border_bottom_color_fg4: readMode
            }"
            (click)="readMode = !readMode || !editMode"
          ></span>
        </div>
      </div>
    </div>
    <div
      class="grow bg flex_row rounded_br rounded_tl overflow_hidden justify_end"
    >
      @if (editMode) {
      <textarea
        class="bg border padding_big rounded_tl vertical_align_bottom hover_highlight_border"
        [ngClass]="{
                        w_50: editMode && readMode,
                        rounded_br: !(editMode && readMode),
                    }"
        [(ngModel)]="this.activeFile"
        (ngModelChange)="saveActiveArchive()"
        (keydown)="textInputOnKeyDown($event)"
      ></textarea>
      } @if (readMode) {
      <div
        class="w_50 bg_s rounded_br rounded_tl padding_big overflow_y_scroll"
        [ngClass]="{
                        w_50: editMode && readMode,
                    }"
        [innerHtml]="this.activeFile | parseMarkdown | async"
      ></div>
      }
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="margin_l flex_col space_between">
    <div class="flex flex_row space_between">
      <div class="flex flex_row margin_b">
        <div
          class="border padding rounded_tl margin_r hover_highlight_border color_fg4 bg hover_cursor_pointer user_select_none"
        >
          Author
        </div>
        <div
          class="border padding margin_r hover_highlight_border bg_s hover_cursor_pointer user_select_none"
        >
          Apple Generator
        </div>
        <div
          class="flex border padding rounded_tr hover_highlight_border border_color_bg hover_cursor_pointer color_fg4 hover_color_fg"
        >
          <span class="icon iconoir-plus"></span>
        </div>
      </div>
      <div
        class="flex border padding margin_b hover_highlight_border hover_cursor_pointer color_fg4 hover_color_fg"
      >
        <span class="icon iconoir-settings"></span>
      </div>
    </div>
    <div
      class="flex_col width_sibedar_width bg grow space_between overflow_hidden margin_b rounded_tr"
    >
      <div class="flex_col overflow_scroll">
        @for (prompt of context_prompts; track prompt) {
        <app-prompt
          [prompt]="prompt"
          [file]="activeFile"
          [llm]="llm"
          [index]="$index"
          (remove)="onRemoveContextClick($index)"
        ></app-prompt>
        }
        <div
          class="border rounded_br rounded_bl rounded_tr padding flex_row space_between hover_highlight_border bg_s hover_cursor_pointer color_fg4 hover_color_fg"
          [ngClass]="{
                        rounded_tl: context_prompts.length > 0,
                    }"
          (click)="onAddContextClick()"
        >
          <span
            class="overflow_hidden grow text_overflow_fade bg_s user_select_none"
            >Provide information</span
          >
          <span class="icon iconoir-plus"></span>
        </div>
      </div>

      <div class="flex_col">
        <div class="flex_row">
          <div class="flex_row">
            <div
              class="flex_row rounded_tl border padding pseudo_input hover_highlight_border bg_h grow"
              title="The amount of new text tokens the LLM may produce before being terminated"
            >
              <input
                class="flex"
                placeholder="Write Tokens"
                [(ngModel)]="writeTokens"
              />
              <span
                class="icon iconoir-data-transfer-down hover_cursor_pointer color_fg4"
              ></span>
            </div>
            <div
              class="flex_row border padding pseudo_input hover_highlight_border bg_h grow"
              title="How many text tokens into the past the LLM gets to read before starting to produce a continuation."
            >
              <input
                class="flex"
                placeholder="Read Tokens"
                [(ngModel)]="readTokens"
              />
              <span
                class="icon iconoir-data-transfer-up hover_cursor_pointer color_fg4"
              ></span>
            </div>
          </div>
          <div class="flex_row">
            <div
              class="border flex_col centered_content padding color_fg4 hover_highlight_border bg_s"
              title="Trigger a generation request for the current dynamic contexts"
            >
              <span
                class="icon iconoir-reload-window hover_cursor_pointer"
                (click)="onClickReloadDynamicContexts()"
              ></span>
            </div>
            <div
              class="border flex_col centered_content padding hover_highlight_border bg_s"
              title="Automatically trigger a generation request for the current dynamic contexts when the text changes"
              [ngClass]="{
                color_fg1: advancedSettings,
                color_fg4: !advancedSettings,
                border_bottom_color_fg4: advancedSettings
              }"
              (click)="advancedSettings = !advancedSettings"
            >
              <span class="icon iconoir-settings hover_cursor_pointer"></span>
            </div>
          </div>
        </div>
        @if (advancedSettings) {
        <div class="flex_row margin_t margin_b">
          <div
            class="flex_row border padding pseudo_input hover_highlight_border bg_h margin_r"
            title="Seed: number that all random number generation is based on"
          >
            <input
              class="flex"
              placeholder="Randomness Seed"
              [(ngModel)]="seed"
            />
            <span
              class="icon iconoir-soil-alt hover_cursor_pointer color_fg4"
            ></span>
          </div>
          <div>
            <div
              class="flex_row border padding pseudo_input hover_highlight_border bg_h margin_b"
              title="Randomness (temperature): higher settings make more probable next token options more likely"
            >
              <input
                class="flex"
                placeholder="Randomness"
                [(ngModel)]="temperature"
              />
              <span
                class="icon iconoir-dice-six hover_cursor_pointer color_fg4"
              ></span>
            </div>
            <div
              class="flex_row border padding pseudo_input hover_highlight_border bg_h"
              title="Variety (top_k): the portion of next token options to consider at all"
            >
              <input class="flex" placeholder="Variety" [(ngModel)]="top_k" />
              <span
                class="icon iconoir-palette hover_cursor_pointer color_fg4"
              ></span>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <div class="flex_col width_sibedar_width">
      <div class="flex_row">
        <div
          class="border rounded_bl padding flex_row grow hover_cursor_pointer hover_highlight_border bg color_fg4 hover_color_fg overflow_hidden"
          (click)="buildPrompt()"
        >
          <span class="overflow_hidden grow text_overflow_fade bg"
            >Continue Text</span
          >
          <span class="icon iconoir-brain-electricity margin_r"></span>
        </div>
      </div>
    </div>
  </div>
</div>
